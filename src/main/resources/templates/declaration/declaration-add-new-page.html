<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header(~{})}">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container py-5 flex-fill">
    <h1 class="mb-4">Insert New Declaration</h1>

    <form id="createDeclarationForm" action="/api/declaration" class="bg-white p-4 rounded shadow-sm">

        <div class="row mb-3">
            <div class="col-md-3">
                <label for="identifierCode" class="form-label fw-bold">ID Code</label>
                <span id="identifierCode-error" class="text-danger"></span>
                <input type="text" id="identifierCode" name="identifierCode" th:value="${identifierCode}" class="form-control" />
            </div>
            <div class="col-md-3">
                <label for="date" class="form-label fw-bold">Date</label>
                <span id="date-error" class="text-danger"></span>
                <input type="text" id="date" name="date" th:value="${date}" class="form-control" />
            </div>
            <div class="col-md-3">
                <label for="clientId" class="form-label fw-bold">Client</label>
                <span id="clientId-error" class="text-danger"></span>
                <select id="clientId" name="clientId" class="form-select">
                    <option></option>
                    <option th:each="client : ${clients}"
                            th:value="${client.clientId}"
                            th:text="${client.fullName}">
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="shipmentId" class="form-label fw-bold">Shipment</label>
                <span id="shipmentId-error" class="text-danger"></span>
                <select id="shipmentId" name="shipmentId" class="form-select">
                    <option></option>
                    <option th:each="shipment : ${shipments}"
                            th:value="${shipment.shipmentId}"
                            th:text="${shipment.shipmentCode}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <h5>Sender Info</h5>
                <label for="senderName" class="form-label">Name</label>
                <input type="text" id="senderName" name="senderName" th:value="${senderName}" class="form-control"/>
                <label for="senderPhoneNumber" class="form-label mt-2">Phone</label>
                <input type="text" id="senderPhoneNumber" name="senderPhoneNumber" th:value="${senderPhoneNumber}" class="form-control"/>
                <label for="senderAddress" class="form-label mt-2">Address</label>
                <input type="text" id="senderAddress" name="senderAddress" th:value="${senderAddress}" class="form-control"/>
                <label for="senderCountryCode" class="form-label mt-2">Country Code</label>
                <input type="text" id="senderCountryCode" name="senderCountryCode" th:value="${senderCountryCode}" class="form-control"/>
            </div>

            <div class="col-md-6">
                <h5>Receiver Info</h5>
                <label for="receiverName" class="form-label">Name</label>
                <input type="text" id="receiverName" name="receiverName" th:value="${receiverName}" class="form-control"/>
                <label for="receiverPhoneNumber" class="form-label mt-2">Phone</label>
                <input type="text" id="receiverPhoneNumber" name="receiverPhoneNumber" th:value="${receiverPhoneNumber}" class="form-control"/>
                <label for="receiverAddress" class="form-label mt-2">Address</label>
                <input type="text" id="receiverAddress" name="receiverAddress" th:value="${receiverAddress}" class="form-control"/>
                <label for="receiverCountryCode" class="form-label mt-2">Country Code</label>
                <input type="text" id="receiverCountryCode" name="receiverCountryCode" th:value="${receiverCountryCode}" class="form-control"/>
            </div>
        </div>

        <div class="mb-4">
            <h5>Package Items</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-light text-dark align-middle" id="package-items-table">
                    <thead class="table-secondary">
                    <tr>
                        <th style="min-width: 250px;">Commodity</th>
                        <th style="width:100px;">Quantity</th>
                        <th style="width:120px;">Net Weight</th>
                        <th style="width:120px;">Value</th>
                        <th style="width:70px;">Used</th>
                        <th style="width:110px;"></th>
                    </tr>
                    </thead>
                    <tbody id="package-items-body">
                    <tr id="template-row" class="d-none">
                        <td class="d-flex gap-2">
                            <select class="form-select commodity-select flex-grow-1">
                                <option value="">Select</option>
                                <option th:each="c : ${commodities}"
                                        th:value="${c.commodityId}"
                                        th:text="${c.commodityCode + ' - ' + c.description}"></option>
                            </select>
                            <input type="text" class="form-control commodity-search flex-grow-1" placeholder="Search code or name"/>
                        </td>
                        <td><input type="number" class="form-control quantity-input"/></td>
                        <td><input type="number" step="0.01" class="form-control net-weight"/></td>
                        <td><input type="number" step="0.01" class="form-control item-value"/></td>
                        <td class="text-center"><input type="checkbox" class="used-checkbox"/></td>
                        <td class="d-flex gap-2">
                            <button type="button" class="btn btn-success btn-sm flex-fill" onclick="addPackageItemRow()">+</button>
                            <button type="button" class="btn btn-danger btn-sm flex-fill" onclick="removePackageItemRow(this)">-</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-primary mt-2" onclick="addPackageItemRow()">Add Item</button>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="totalWeight" class="form-label fw-bold">Total Weight</label>
                <span id="totalWeight-error" class="text-danger"></span>
                <input type="text" id="totalWeight" name="totalWeight" th:value="${totalWeight}" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="totalValue" class="form-label fw-bold">Total Value</label>
                <span id="totalValue-error" class="text-danger"></span>
                <input type="text" id="totalValue" name="totalValue" th:value="${totalValue}" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="packageAmount" class="form-label fw-bold">Package Count</label>
                <span id="packageAmount-error" class="text-danger"></span>
                <input type="number" id="packageAmount" name="packageAmount" th:value="${packageAmount}" class="form-control" />
            </div>
        </div>

        <div class="text-center">
            <button type="button" class="btn btn-primary" onclick="createDeclaration()">Submit Declaration</button>
        </div>
    </form>

    <div th:if="${errorMessage}" class="alert alert-danger mt-3" th:text="${errorMessage}"></div>

    <form th:action="@{/declaration}" method="get" class="mt-3">
        <div class="text-start">
            <button type="submit" class="btn btn-secondary">Back</button>
        </div>
    </form>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script>

    document.addEventListener('DOMContentLoaded', () => {
        const idInput = document.getElementById('identifierCode');
        if (idInput && !idInput.value) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const yy = String(yyyy).slice(-2);
            const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
            const mmm = monthNames[now.getMonth()];
            const dd = String(now.getDate()).padStart(2,'0');
            const hh = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');

            idInput.value = `${dd}_${hh}${mm}${mmm}${yy}`;
        }
    });

    function recalcTotals() {
        let totalWeight = 0;
        let totalValue = 0;

        const rows = $("#package-items-body tr").not("#template-row");
        rows.each(function () {
            const row = $(this);

            const weight = parseFloat(row.find(".net-weight").val()) || 0;
            const value = parseFloat(row.find(".item-value").val()) || 0;

            totalWeight += weight;
            totalValue += value;
        });

        $("#totalWeight").val(totalWeight.toFixed(2));
        $("#totalValue").val(totalValue.toFixed(2));
    }

    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('date');
        if (dateInput && !dateInput.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
    });

    document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('commodity-search')) return;

        const input = e.target;
        const query = input.value.toLowerCase();
        const select = input.closest('td').querySelector('.commodity-select');

        Array.from(select.options).forEach(option => {
            const text = option.text.toLowerCase();
            option.hidden = text.indexOf(query) === -1;
        });

        const firstVisible = Array.from(select.options).find(opt => !opt.hidden);
        if (firstVisible) select.value = firstVisible.value;
    });

    function addPackageItemRow() {
        const tbody = document.getElementById('package-items-body');
        const template = document.getElementById('template-row');
        const newRow = template.cloneNode(true);

        newRow.classList.remove('d-none');
        newRow.removeAttribute('id');

        tbody.appendChild(newRow);
        updatePackageItemNames();

        recalcTotals();
    }

    function removePackageItemRow(button) {
        const row = button.closest('tr');
        row.remove();
        updatePackageItemNames();

        recalcTotals();
    }

    function updatePackageItemNames() {
        const rows = document.querySelectorAll('#package-items-body tr:not(#template-row)');
        rows.forEach((row, index) => {
            row.querySelectorAll('select, input').forEach(input => {
                if (input.classList.contains('commodity-select')) {
                    input.name = `packageItems[${index}].commodityId`;
                } else if (input.classList.contains('quantity-input')) {
                    input.name = `packageItems[${index}].quantity`;
                } else if (input.classList.contains('net-weight')) {
                    input.name = `packageItems[${index}].netWeight`;
                } else if (input.classList.contains('item-value')) {
                    input.name = `packageItems[${index}].value`;
                } else if (input.classList.contains('used-checkbox')) {
                    input.name = `packageItems[${index}].used`;
                }
            });
        });
    }

    const createDeclaration = () => {
        const url = $("#createDeclarationForm").attr('action');
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfValue = $("meta[name='_csrf']").attr("content");

        const packageItems = [];
        $("#package-items-body tr").not("#template-row").each(function() {
            const row = $(this);
            const item = {
                commodityId: row.find(".commodity-select").val(),
                quantity: parseFloat(row.find(".quantity-input").val()),
                netWeight: parseFloat(row.find(".net-weight").val()),
                value: parseFloat(row.find(".item-value").val()),
                used: row.find(".used-checkbox").is(":checked")
            };
            packageItems.push(item);
        });

        const request = {
            senderName: $("#senderName").val(),
            senderPhoneNumber: $("#senderPhoneNumber").val(),
            senderAddress: $("#senderAddress").val(),
            senderCountryCode: $("#senderCountryCode").val(),
            receiverName: $("#receiverName").val(),
            receiverPhoneNumber: $("#receiverPhoneNumber").val(),
            receiverAddress: $("#receiverAddress").val(),
            receiverCountryCode: $("#receiverCountryCode").val(),
            packageItems: packageItems,
            identifierCode: $("#identifierCode").val(),
            clientId: $("#clientId").val(),
            totalWeight: $("#totalWeight").val(),
            totalValue: $("#totalValue").val(),
            packageAmount: $("#packageAmount").val(),
            date: $("#date").val(),
            shipmentId: $("#shipmentId").val()
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfValue
            },
            body: JSON.stringify(request),
        })
        .then(response => {
            if (!response.ok) {
                response.json().then(handleErrorResponse);
            } else {
                window.location.href = '/declaration';
            }
        })
        .catch(error => {
            console.error("Fetch error:", error);
        });
    };

    const handleErrorResponse = (errorResponse) => {
        if (errorResponse.fieldErrors) {
            handleFieldErrors(errorResponse.fieldErrors);
        } else {
            handleErrorMessage(errorResponse.errorMessage);
        }
    };

    const handleFieldErrors = (fieldErrors) => {
        $(".error-message").text("");
        for (let field in fieldErrors) {
            $(`#${field}-error`).text(fieldErrors[field]);
        }
    };

    const handleErrorMessage = (errorMessage) => {
        $("#errorMessage").text(errorMessage);
    };

    $(document).on("input", ".net-weight, .item-value", function () {
        recalcTotals();
    });

</script>

</body>
</html>