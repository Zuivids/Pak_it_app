<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header(~{})}">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container py-5 flex-fill">
    <h1 class="mb-4">Shipment List</h1>
    <div class="table-responsive rounded">
        <table class="table table-bordered table-striped align-middle">
            <tr>
                <th>Shipment code</th>
                <th>Delivery date</th>
                <th>Delivery state</th>
                <th colspan="3"></th>
            </tr>
            <tr>
                <th><input id="shipmentCode" type="text" class="form-control" th:value="${query.shipmentCode}"/></th>
                <th>
                    <div id="deliveryDate-container" class="input-group" data-td-target-input="nearest" data-td-target-toggle="nearest">
                        <input id="deliveryDate" th:value="${#temporals.format(query.deliveryDate, 'dd-MM-yyyy')}" class="form-control" type="text" data-td-target="#deliveryDate-container">
                        <span class="input-group-text" data-td-target="#deliveryDate-container" data-td-toggle="datetimepicker">
                            <i class="fa-solid fa-calendar"></i>
                        </span>
                    </div>
                </th>
                <th>
                    <select id="deliveryState" name="deliveryState" class="form-select" required>
                        <option></option>
                        <option th:each="deliveryState : ${T(lv.pakit.model.shipment.DeliveryState).values()}"
                                th:value="${deliveryState.name}"
                                th:text="${deliveryState.publicName}"
                                th:selected="${query.deliveryState == deliveryState}">
                        </option>
                    </select>
                </th>
                <th colspan="3">
                    <button onclick="search()" type="submit" class="btn btn-outline-primary w-100">Search</button>
                </th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="shipment : ${shipments}">
                <td th:text="${shipment.shipmentCode}"></td>
                <td th:text="${#temporals.format(shipment.deliveryDatetime, 'dd-MM-yyyy HH:mm')}"></td>
                <td th:text="${shipment.deliveryState.publicName}"></td>
                <td class="text-center">
                    <form th:action="|/shipment/${shipment.shipmentId}|" method="get" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-sm">View</button>
                    </form>
                </td>
                <td class="text-center">
                    <form th:action="|/shipment/${shipment.shipmentId}/edit|" method="get" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-sm">Edit</button>
                    </form>
                </td>
                <td class="text-center" th:if="${@authService.isAdmin()}">
                    <form class="d-inline" method="get" th:action="|/shipment/${shipment.shipmentId}/delete|">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(shipments)}">
                <td colspan="16" class="text-center text-muted">No shipments found.</td>
            </tr>

            </tbody>
        </table>
    </div>

    <div th:if="${errorMessage != null}" class="alert alert-danger" role="alert">
        <span th:text="${errorMessage}"></span>
    </div>

    <form th:action="@{/home}" method="get" class="mt-4">
        <button type="submit" class="btn btn-secondary">Back</button>
    </form>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script>
    var deliveryDatetimePicker;

    document.addEventListener("DOMContentLoaded", () => {
        deliveryDatetimePicker = new tempusDominus.TempusDominus(document.getElementById("deliveryDate-container"), {
            display: {
                viewMode: 'calendar',
                components: {
                    decades: false,
                    year: true,
                    month: true,
                    date: true,
                    hours: false,
                    minutes: false,
                    seconds: false
                },
                buttons: {
                  today: true,
                  clear: true
                }
            },
            localization: {
                format: "dd-MM-yyyy"
            },
            useCurrent: false
        });
    });

    const search = () => {
        const shipmentCode = $("#shipmentCode").val();
        const deliveryState = $("#deliveryState").val();

        const lastPickedDate = deliveryDatetimePicker.dates.lastPicked;
        const deliveryDate = lastPickedDate ? moment(deliveryDatetimePicker.dates.lastPicked).format("YYYY-MM-DD") : "";

        console.log(deliveryDate);

        const params = new URLSearchParams({
            shipmentCode: shipmentCode,
            deliveryDate: deliveryDate,
            deliveryState: deliveryState
        });

        window.location.href = `/shipment?${params.toString()}`;
    };
</script>

</body>
</html>
