<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: header(~{})}">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container py-5 flex-fill">
    <h1 class="mb-4">Edit Declaration</h1>

    <div class="bg-white p-4 rounded shadow-sm">
        <form id="editDeclarationForm" th:action="|/api/declaration/${declaration.declarationId}|" method="post">
            <div class="row mb-3">

                <div class="row mb-3">
                    <div class="col-md-4">
                        <p><strong>Created by:</strong> <span th:text="${declaration.createdBy}"></span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Created at:</strong> <span th:text="${declaration.createdAt}"></span></p>
                    </div>
                </div>

                <div class="col-md-6">
                    <h5>Sender Info</h5>
                    <label class="form-label">Name</label>
                    <span id="senderName-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="senderName" th:value="${declaration.senderName}">

                    <label class="form-label">Phone</label>
                    <span id="senderPhoneNumber-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="senderPhoneNumber" th:value="${declaration.senderPhoneNumber}">

                    <label class="form-label">Address</label>
                    <span id="senderAddress-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="senderAddress" th:value="${declaration.senderAddress}">

                    <label class="form-label">Country Code</label>
                    <span id="senderCountryCode-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="senderCountryCode" th:value="${declaration.senderCountryCode}">
                </div>
                <div class="col-md-6">
                    <h5>Receiver Info</h5>
                    <label class="form-label">Name</label>
                    <span id="receiverName-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="receiverName" th:value="${declaration.receiverName}">

                    <label class="form-label">Phone</label>
                    <span id="receiverPhoneNumber-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="receiverPhoneNumber" th:value="${declaration.receiverPhoneNumber}">

                    <label class="form-label">Address</label>
                    <span id="receiverAddress-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="receiverAddress" th:value="${declaration.receiverAddress}">

                    <label class="form-label">Country Code</label>
                    <span id="receiverCountryCode-error" class="text-danger"></span>
                    <input type="text" class="form-control" id="receiverCountryCode" th:value="${declaration.receiverCountryCode}">
                </div>
            </div>

            <div class="mb-4">
                <h5>Package Items</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-light text-dark align-middle" id="package-items-table">
                        <thead class="table-secondary">
                        <tr>
                            <th style="min-width: 250px;">Commodity</th>
                            <th style="width:100px;">Quantity</th>
                            <th style="width:120px;">Net Weight</th>
                            <th style="width:120px;">Value</th>
                            <th style="width:70px;">Used</th>
                            <th style="width:110px;"></th>
                        </tr>
                        </thead>
                        <tbody id="package-items-body">
                        <tr id="template-row" class="d-none">
                            <td class="d-flex gap-2">
                                <select class="form-select commodity-select flex-grow-1">
                                    <option value="">Select</option>
                                    <option th:each="c : ${commodities}"
                                            th:value="${c.commodityId}"
                                            th:text="${c.commodityCode + ' - ' + c.description}"></option>
                                </select>
                                <input type="text" class="form-control commodity-search flex-grow-1" placeholder="Search code or name"/>
                            </td>
                            <td><input type="number" class="form-control quantity-input"/></td>
                            <td><input type="number" step="0.01" class="form-control net-weight"/></td>
                            <td><input type="number" step="0.01" class="form-control item-value"/></td>
                            <td class="text-center"><input type="checkbox" class="used-checkbox"/></td>
                            <td class="d-flex gap-2">
                                <button type="button" class="btn btn-success btn-sm flex-fill" onclick="addPackageItemRow()">+</button>
                                <button type="button" class="btn btn-danger btn-sm flex-fill" onclick="removePackageItemRow(this)">-</button>
                            </td>
                        </tr>

                        <tr th:each="item, iterStat : ${declaration.packageItems}">
                            <td class="d-flex gap-2">
                                <select class="form-select commodity-select flex-grow-1"
                                        th:name="|packageItems[${iterStat.index}].commodityId|"
                                        th:value="${item.commodity.commodityId}">
                                    <option value="">Select</option>
                                    <option th:each="c : ${commodities}"
                                            th:value="${c.commodityId}"
                                            th:selected="${item.commodity.commodityId} == ${c.commodityId}"
                                            th:text="${c.commodityCode + ' - ' + c.description}">
                                    </option>
                                </select>
                                <input type="text" class="form-control commodity-search flex-grow-1" placeholder="Search code or name"/>
                            </td>
                            <td><input type="number" class="form-control quantity-input" th:name="|packageItems[${iterStat.index}].quantity|" th:value="${item.quantity}" /></td>
                            <td><input type="number" step="0.01" class="form-control net-weight" th:name="|packageItems[${iterStat.index}].netWeight|" th:value="${item.netWeight}" /></td>
                            <td><input type="number" step="0.01" class="form-control item-value" th:name="|packageItems[${iterStat.index}].value|" th:value="${item.value}" /></td>
                            <td class="text-center">
                                <input type="checkbox" class="used-checkbox" th:name="|packageItems[${iterStat.index}].used|" value="true" th:checked="${item.used}" />
                            </td>
                            <td class="d-flex gap-2">
                                <button type="button" class="btn btn-success btn-sm flex-fill" onclick="addPackageItemRow()">+</button>
                                <button type="button" class="btn btn-danger btn-sm flex-fill" onclick="removePackageItemRow(this)">-</button>
                            </td>
                        </tr>

                        <tr id="no-items-found-row" th:if="${declaration.packageItems == null || declaration.packageItems.isEmpty()}">
                            <td colspan="6" class="text-center">No package items found.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-primary mt-2" onclick="addPackageItemRow()">Add Item</button>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">ID Code</label>
                    <span id="identifierCode-error" class="text-danger"></span>
                    <input type="text" id="identifierCode" class="form-control" th:value="${declaration.identifierCode}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date</label>
                    <span id="declarationDate-error" class="text-danger"></span>
                    <input type="text" id="declarationDate" class="form-control" th:value="${declaration.date}">
                </div>
                <div class="col-md-4">
                    <label for="clientId" class="form-label fw-bold">Client</label>
                    <span id="clientId-error" class="text-danger"></span>
                    <select id="clientId" name="clientId" class="form-select">
                        <option value="">Select a client</option>
                        <option th:each="client : ${clients}"
                                th:value="${client.clientId}"
                                th:text="${client.fullName}"
                                th:selected="${client.clientId} == ${declaration.clientId}">
                        </option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Total Weight</label>
                    <span id="totalWeight-error" class="text-danger"></span>
                    <input type="text" id="totalWeight" class="form-control" th:value="${declaration.totalWeight}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Total Value</label>
                    <span id="totalValue-error" class="text-danger"></span>
                    <input type="text" id="totalValue" class="form-control" th:value="${declaration.totalValue}">
                </div>
            </div>

            <div class="text-danger mb-3" id="errorMessage"></div>

            <div class="text-center">
                <button type="button" class="btn btn-success" onclick="editDeclaration()">Update Declaration</button>
            </div>
        </form>

        <form action="/declaration" method="get" class="mt-3 text-center">
            <div class="text-start">
                <button type="submit" class="btn btn-secondary">Back</button>
            </div>
        </form>
    </div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script>
    function addPackageItemRow() {
        const tbody = document.getElementById('package-items-body');
        const template = document.getElementById('template-row');
        const newRow = template.cloneNode(true);

        newRow.classList.remove('d-none');
        newRow.removeAttribute('id');

        tbody.appendChild(newRow);
        updatePackageItemNames();
        $("#no-items-found-row").hide();

        recalcTotals();
    }

    function removePackageItemRow(button) {
        const row = button.closest('tr');
        row.remove();
        updatePackageItemNames();

        recalcTotals();
    }

    document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('commodity-search')) return;

        const input = e.target;
        const query = input.value.toLowerCase();
        const select = input.closest('td').querySelector('.commodity-select');

        Array.from(select.options).forEach(option => {
            const text = option.text.toLowerCase();
            option.hidden = text.indexOf(query) === -1;
        });

        const firstVisible = Array.from(select.options).find(opt => !opt.hidden);
        if (firstVisible) select.value = firstVisible.value;
    });

    function updatePackageItemNames() {
        const rows = $("#package-items-body tr").not("#template-row").not("#no-items-found-row");
        rows.each(function (index) {
            const row = $(this);
            row.find('select, input').each(function () {
                const input = $(this);

                if (input.hasClass('commodity-select')) {
                    input.attr('name', `packageItems[${index}].commodityId`);
                } else if (input.hasClass('quantity-input')) {
                    input.attr('name', `packageItems[${index}].quantity`);
                } else if (input.hasClass('net-weight')) {
                    input.attr('name', `packageItems[${index}].netWeight`);
                } else if (input.hasClass('item-value')) {
                    input.attr('name', `packageItems[${index}].value`);
                } else if (input.hasClass('used-checkbox')) {
                    input.attr('name', `packageItems[${index}].used`);
                }
            });
        });
    }

    const editDeclaration = () => {
        const url = $("#editDeclarationForm").attr('action');
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfValue = $("meta[name='_csrf']").attr("content");

        const packageItems = [];
        const rows = $("#package-items-body tr").not("#template-row").not("#no-items-found-row");
        rows.each(function () {
            const row = $(this);
            packageItems.push({
                commodityId: parseInt(row.find("select[name*='commodityId']").val()),
                quantity: parseFloat(row.find("input[name*='quantity']").val()),
                netWeight: parseFloat(row.find("input[name*='netWeight']").val()),
                value: parseFloat(row.find("input[name*='value']").val()),
                used: row.find("input[type='checkbox']").prop("checked")
            });
        });
        const request = {
            senderName: $("#senderName").val(),
            senderPhoneNumber: $("#senderPhoneNumber").val(),
            senderAddress: $("#senderAddress").val(),
            senderCountryCode: $("#senderCountryCode").val(),

            receiverName: $("#receiverName").val(),
            receiverPhoneNumber: $("#receiverPhoneNumber").val(),
            receiverAddress: $("#receiverAddress").val(),
            receiverCountryCode: $("#receiverCountryCode").val(),

            packageItems: packageItems,

            identifierCode: $("#identifierCode").val(),
            date: $("#declarationDate").val(),
            clientId: $("#clientId").val()
        };

        fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfValue
            },
            body: JSON.stringify(request),
        })
        .then(response => {
            if (!response.ok) {
                response.json().then(handleErrorResponse);
            } else {
                window.location.href = '/declaration';
            }
        })
        .catch(error => {
            console.log(error);
        });
    };

    const handleErrorResponse = (errorResponse) => {
        if (errorResponse.fieldErrors) {
            handleFieldErrors(errorResponse.fieldErrors);
        } else {
            handleErrorMessage(errorResponse.errorMessage);
        }
    };

    const handleFieldErrors = (fieldErrors) => {
        console.log(fieldErrors);
        for (let field in fieldErrors) {
            $(`#${field}-error`).text(fieldErrors[field]);
        }
    };

    const handleErrorMessage = (errorMessage) => {
        $("#errorMessage").text(errorMessage);
    };

    function recalcTotals() {
        let totalWeight = 0;
        let totalValue = 0;

        const rows = $("#package-items-body tr").not("#template-row").not("#no-items-found-row");
        rows.each(function () {
            const row = $(this);

            const qty = parseFloat(row.find(".quantity-input").val()) || 0;
            const weight = parseFloat(row.find(".net-weight").val()) || 0;
            const value = parseFloat(row.find(".item-value").val()) || 0;

            // weight is per-item weight * qty
            totalWeight += weight * qty;
            // value is per-item value * qty
            totalValue += value * qty;
        });

        $("#totalWeight").val(totalWeight.toFixed(2));
        $("#totalValue").val(totalValue.toFixed(2));
    }

    $(document).on("input", ".quantity-input, .net-weight, .item-value", function () {
        recalcTotals();
    });

</script>

</body>
</html>
