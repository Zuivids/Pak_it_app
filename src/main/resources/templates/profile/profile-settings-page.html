<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/layout :: header(~{::#headerChildren})">
    <div id="headerChildren">
        <style>
            .cell {
                display: flex;
                align-items: center;
            }
            .field-name-cell {
                display: flex;
                align-items: center;
                font-weight: 700;
            }
        </style>
    </div>
</head>

<body class="bg-light">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container py-5">
    <h1 class="mb-4" th:text="|Settings for user ${user.username}|"></h1>

    <div class="row mb-2">
        <div class="col-2 field-name-cell">
            <span>Email:</span>
        </div>
        <div class="col-2 cell">
            <span th:text="${user.email}"></span>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-2 field-name-cell">
            <span>2FA status:</span>
        </div>
        <div class="col-2 cell">
            <span th:classappend="${user.isTotp} ? text-success : text-danger"
                  th:text="${user.isTotp} ? 'Confirmed' : 'Unavailable'"></span>
        </div>
        <div class="col-2 cell">
            <button class="btn btn-success" onclick="start2FASetup()">Set up</button>
        </div>
    </div>
</main>

<div id="setup2FAModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ol>
                    <li>Download an authenticator app (e.g. Google Authenticator)</li>
                    <li>Scan the QR code below</li>
                    <li>Confirm the code in the input below</li>
                </ol>
                <div class="mt-5 d-flex justify-content-center">
                    <div id="qrCodeSpinner" class="spinner-border" role="status"></div>
                    <img id="qrCode" class="d-none" src="" alt=""/>
                </div>
                <div class="mt-5">
                    <label for="totp" class="form-label">Authenticator code</label>
                    <input type="text" class="form-control w-25" id="totp" name="totp">
                    <span id="totp-error" class="error-message text-danger"></span>
                </div>
                <div class="mt-3">
                    <span id="errorMessage" class="error-message text-danger mb-2 d-block"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirm2FACode()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    const start2FASetup = () => {
        $("#setup2FAModal").modal("show");

        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfValue = $("meta[name='_csrf']").attr("content");

        fetch("/api/profile/settings/2fa/setup", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfValue
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(handleErrorResponse);
            }

            response.json().then(showQRCode);
        })
        .catch(error => {
            handleErrorMessage("An unexpected error occurred.");
        });
    };

    const showQRCode = (qrCodeResponse) => {
        $("#qrCodeSpinner").hide();

        $("#qrCode").attr("src", qrCodeResponse.qrCode);
        $("#qrCode").removeClass("d-none");
    };

    const confirm2FACode = () => {
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        const csrfValue = $("meta[name='_csrf']").attr("content");

        const request = {
            totp: $("#totp").val() || null
        };

        fetch("/api/profile/settings/2fa/confirm", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfValue
            },
            body: JSON.stringify(request)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(handleErrorResponse);
            }

            window.location.reload();
        })
        .catch(error => {
            handleErrorMessage("An unexpected error occurred.");
        });
    };

    const handleErrorResponse = (errorResponse) => {
        $(".error-message").text("");

        if (errorResponse.fieldErrors) {
            handleFieldErrors(errorResponse.fieldErrors);
        } else {
            handleErrorMessage(errorResponse.errorMessage);
        }
    };

    const handleFieldErrors = (fieldErrors) => {
        for (let field in fieldErrors) {
            $(`#${field}-error`).text(fieldErrors[field]);
        }
    };

    const handleErrorMessage = (errorMessage) => {
        $("#errorMessage").text(errorMessage);
    };
</script>

<footer th:replace="~{fragments/layout :: footer}"></footer>

</body>
</html>
